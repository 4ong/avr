#!/bin/bash

fname="$1"
p_dir="$2"
bm="$3"
p_out="$4"
p_bin="$5"
p_yosys="$6"
clk="$7"
timeMax="$8"
memMax="$9"
split="${10}"
random="${11}"
verbosity="${12}"

BM_PATH="$p_dir"
OUT_DIR="$p_out"
mkdir -p $OUT_DIR

DEFAULT_TOP="main"
DEFAULT_CLK="clk"
DEFAULT_PROP="prop"

AUTOTOP=1
if [ $# -ge 14 ]
then
	top=${14}
	AUTOTOP=0
else
	top=$DEFAULT_TOP
fi

# echo "bm: $bm" "fname: $fname" "top: $top"

OUT_PATH="$OUT_DIR/work_$bm"

rm -rf $OUT_PATH
mkdir $OUT_PATH
cp -R $BM_PATH/* $OUT_PATH
mkdir $OUT_PATH/data
mkdir $OUT_PATH/dot
mkdir $OUT_PATH/dot/ref

echo "design_file" > $OUT_PATH/fconfig
echo "$BM_PATH/$fname" >> $OUT_PATH/fconfig
	
echo "top_module" >> $OUT_PATH/fconfig
echo $top >> $OUT_PATH/fconfig

echo "clock_sig" >> $OUT_PATH/fconfig
echo "$DEFAULT_CLK" >> $OUT_PATH/fconfig

echo "prop_sig" >> $OUT_PATH/fconfig
echo "$DEFAULT_PROP" >> $OUT_PATH/fconfig

echo "timeout" >> $OUT_PATH/fconfig
echo "$timeMax" >> $OUT_PATH/fconfig

echo "memory_limit" >> $OUT_PATH/fconfig
echo "$memMax" >> $OUT_PATH/fconfig

echo "split_signals" >> $OUT_PATH/fconfig
echo "$split" >> $OUT_PATH/fconfig

echo "random" >> $OUT_PATH/fconfig
echo "$random" >> $OUT_PATH/fconfig

OUT_YOSYS="$bm".ilang
OUT_VERILOG="$bm"_y.v

YOSYS_CMD=$OUT_PATH/yosys.tcl
rm -f $YOSYS_CMD

echo "yosys read_verilog -noopt -nolatches -sv $OUT_PATH/$fname;" >> $YOSYS_CMD
if [ $AUTOTOP ]
then
	echo "yosys hierarchy -auto-top;" >> $YOSYS_CMD
else
	echo "yosys hierarchy -top $top;" >> $YOSYS_CMD
fi
echo "yosys hierarchy -libdir $OUT_PATH;" >> $YOSYS_CMD
echo "yosys hierarchy -check;" >> $YOSYS_CMD
echo "yosys rename -top $top;" >> $YOSYS_CMD
echo "yosys delete -output $top;" >> $YOSYS_CMD
echo "yosys expose $top/"prop_neg";" >> $YOSYS_CMD
echo "yosys proc;" >> $YOSYS_CMD
echo "yosys clean;" >> $YOSYS_CMD
echo "yosys splitnets -driver;" >> $YOSYS_CMD
echo "yosys clean;" >> $YOSYS_CMD
echo "yosys pmuxtree;" >> $YOSYS_CMD
echo "yosys clean;" >> $YOSYS_CMD
echo "yosys memory;" >> $YOSYS_CMD
echo "yosys clean;" >> $YOSYS_CMD
echo "yosys flatten;" >> $YOSYS_CMD
echo "yosys clean -purge;" >> $YOSYS_CMD
echo "yosys setundef -undriven -expose -undef;" >> $YOSYS_CMD
echo "yosys clean;" >> $YOSYS_CMD
echo "yosys check;" >> $YOSYS_CMD
echo "yosys write_ilang $OUT_PATH/$OUT_YOSYS;" >> $YOSYS_CMD
echo "yosys write_verilog -attr2comment $OUT_PATH/$OUT_VERILOG;" >> $YOSYS_CMD
$p_yosys/yosys -c $YOSYS_CMD -Q -T -q -q -l $OUT_PATH/yosys.log


$p_bin/vwn   $OUT_PATH $p_bin > $OUT_PATH/data/vwn.output 2>> $OUT_PATH/avr.err
$p_bin/dpa   $OUT_PATH $p_bin > $OUT_PATH/data/dpa.output 2>> $OUT_PATH/avr.err
$p_bin/reach $OUT_PATH $p_bin > $OUT_PATH/data/reach.output 2>> >(tee -a $OUT_PATH/avr.err >&2)
avr_exit=$?

tail -n 3 $OUT_PATH/data/reach.output &> >(tee -a $OUT_PATH/avr.err >&2)
echo "" &> >(tee -a $OUT_PATH/avr.err >&2)

exit $avr_exit
